<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>网关Spring Cloud Gateway Filter实战 | 雨中云居</title>
    <meta name="description" content="网关Spring Cloud Gateway Filter实战step by step">
    <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.4d43a9e3.css" as="style"><link rel="preload" href="/assets/js/app.2f09ff3d.js" as="script"><link rel="preload" href="/assets/js/5.74ec0765.js" as="script"><link rel="preload" href="/assets/js/25.18f85102.js" as="script"><link rel="prefetch" href="/assets/js/1.c53ecec0.js"><link rel="prefetch" href="/assets/js/10.023159e0.js"><link rel="prefetch" href="/assets/js/11.025f9b8d.js"><link rel="prefetch" href="/assets/js/12.3b6a83a9.js"><link rel="prefetch" href="/assets/js/13.b9db9f21.js"><link rel="prefetch" href="/assets/js/14.f0a0d27e.js"><link rel="prefetch" href="/assets/js/15.f847b5b1.js"><link rel="prefetch" href="/assets/js/16.1eb044f7.js"><link rel="prefetch" href="/assets/js/17.7f057615.js"><link rel="prefetch" href="/assets/js/18.1c8e69b2.js"><link rel="prefetch" href="/assets/js/19.3a0212e5.js"><link rel="prefetch" href="/assets/js/20.7bd697d2.js"><link rel="prefetch" href="/assets/js/21.8969053f.js"><link rel="prefetch" href="/assets/js/22.2d3de7e9.js"><link rel="prefetch" href="/assets/js/23.4d86525b.js"><link rel="prefetch" href="/assets/js/24.53c1b64a.js"><link rel="prefetch" href="/assets/js/26.aea4a9de.js"><link rel="prefetch" href="/assets/js/27.2819c090.js"><link rel="prefetch" href="/assets/js/28.417cefb4.js"><link rel="prefetch" href="/assets/js/29.b9848050.js"><link rel="prefetch" href="/assets/js/30.3bba88f0.js"><link rel="prefetch" href="/assets/js/31.3a0210cd.js"><link rel="prefetch" href="/assets/js/32.5e927a02.js"><link rel="prefetch" href="/assets/js/33.cb43ca24.js"><link rel="prefetch" href="/assets/js/34.c0e2184c.js"><link rel="prefetch" href="/assets/js/35.2603752d.js"><link rel="prefetch" href="/assets/js/36.5d2b162a.js"><link rel="prefetch" href="/assets/js/37.df45725b.js"><link rel="prefetch" href="/assets/js/38.8ec22f07.js"><link rel="prefetch" href="/assets/js/39.3d68f7b8.js"><link rel="prefetch" href="/assets/js/4.de60fea4.js"><link rel="prefetch" href="/assets/js/40.3a19b469.js"><link rel="prefetch" href="/assets/js/41.500fc3dd.js"><link rel="prefetch" href="/assets/js/42.6ac9cf39.js"><link rel="prefetch" href="/assets/js/43.c3ad6aac.js"><link rel="prefetch" href="/assets/js/44.61e4ad80.js"><link rel="prefetch" href="/assets/js/45.37bb92ea.js"><link rel="prefetch" href="/assets/js/6.1b229177.js"><link rel="prefetch" href="/assets/js/7.bd2e9573.js"><link rel="prefetch" href="/assets/js/8.838426a4.js"><link rel="prefetch" href="/assets/js/9.1b478aea.js"><link rel="prefetch" href="/assets/js/vuejs-paginate.e02251a5.js">
    <link rel="stylesheet" href="/assets/css/0.styles.4d43a9e3.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="vuepress-theme-blog__global-layout"><section id="header-wrapper"><header id="header"><div class="header-wrapper"><div class="title"><a href="/" class="nav-link home-link">雨中云居 </a></div> <div class="header-right-wrap"><ul class="nav"><li class="nav-item"><a href="/essay/" class="nav-link">软件随笔</a></li><li class="nav-item"><a href="/ms/" class="nav-link">微服务</a></li><li class="nav-item"><a href="/frontend/" class="nav-link">前端</a></li><li class="nav-item"><a href="https://github.com/shineyjg" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li></ul> <div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></div></header></section> <div id="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">雨中云居 </a> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><hr class="menu-divider"> <ul class="mobile-nav"><li class="mobile-nav-item"><a href="/essay/" class="nav-link">软件随笔</a></li><li class="mobile-nav-item"><a href="/ms/" class="nav-link">微服务</a></li><li class="mobile-nav-item"><a href="/frontend/" class="nav-link">前端</a></li><li class="mobile-nav-item"><a href="https://github.com/shineyjg" target="_blank" rel="noopener noreferrer" class="nav-link external">Github</a></li> <li class="mobile-nav-item"><!----></li></ul></div></div></div> <div class="content-wrapper"><div id="vuepress-theme-blog__post-layout"><article itemscope="itemscope" itemtype="https://schema.org/BlogPosting" class="vuepress-blog-theme-content"><header><h1 itemprop="name headline" class="post-title">
        网关Spring Cloud Gateway Filter实战
      </h1> <div class="post-meta"><!----> <div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-clock"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg> <time pubdate itemprop="datePublished" datetime="2018-09-14T00:00:00.000Z">
      2018-09-14
    </time></div> <ul itemprop="keywords" class="post-meta-tags"><li class="post-tag" data-v-d832e844><a href="/tag/微服务" data-v-d832e844> 微服务 </a></li><li class="post-tag" data-v-d832e844><a href="/tag/网关" data-v-d832e844> 网关 </a></li><li class="post-tag" data-v-d832e844><a href="/tag/Spring Cloud Gateway" data-v-d832e844> Spring Cloud Gateway </a></li><li class="post-tag" data-v-d832e844><a href="/tag/Filter" data-v-d832e844> Filter </a></li></ul></div></header> <div itemprop="articleBody" class="content__default"><h2 id="一、准备工作"><a href="#一、准备工作" aria-hidden="true" class="header-anchor">#</a> 一、准备工作</h2> <h3 id="_1-docker-容器"><a href="#_1-docker-容器" aria-hidden="true" class="header-anchor">#</a> 1. <a href="/2018/08/24/玩转docker/">docker &amp; 容器</a></h3> <h3 id="_2-consul注册发现服务中心"><a href="#_2-consul注册发现服务中心" aria-hidden="true" class="header-anchor">#</a> 2. <a href="/2018/08/26/服务注册发现consul起步/">consul注册发现服务中心</a></h3> <h3 id="_3-provider微服务实战"><a href="#_3-provider微服务实战" aria-hidden="true" class="header-anchor">#</a> 3. <a href="/2018/08/29/Provider微服务实战/">Provider微服务实战</a></h3> <h3 id="_4-consumer微服务实战"><a href="#_4-consumer微服务实战" aria-hidden="true" class="header-anchor">#</a> 4. <a href="/2018/08/31/Consumer微服务实战/">Consumer微服务实战</a></h3> <h3 id="_5-网关spring-cloud-gateway实战"><a href="#_5-网关spring-cloud-gateway实战" aria-hidden="true" class="header-anchor">#</a> 5. <a href="/2018/09/03/网关spring-cloud-gateway实战/">网关spring-cloud-gateway实战</a></h3> <h2 id="二、应用场景"><a href="#二、应用场景" aria-hidden="true" class="header-anchor">#</a> 二、应用场景</h2> <h3 id="_1-统一认证"><a href="#_1-统一认证" aria-hidden="true" class="header-anchor">#</a> 1. 统一认证</h3> <h3 id="_2-屏蔽内部微服务接口"><a href="#_2-屏蔽内部微服务接口" aria-hidden="true" class="header-anchor">#</a> 2. 屏蔽内部微服务接口</h3> <h3 id="_3-灰度"><a href="#_3-灰度" aria-hidden="true" class="header-anchor">#</a> 3. 灰度</h3> <h3 id="_4-进出口日志"><a href="#_4-进出口日志" aria-hidden="true" class="header-anchor">#</a> 4. 进出口日志</h3> <h2 id="三、原理"><a href="#三、原理" aria-hidden="true" class="header-anchor">#</a> 三、原理</h2> <h3 id="_1-总原理图"><a href="#_1-总原理图" aria-hidden="true" class="header-anchor">#</a> 1. 总原理图</h3> <p><img src="/assets/img/principle.0079ac3f.png" alt="图片" title="图片"></p> <h3 id="_2-多个filter形成链"><a href="#_2-多个filter形成链" aria-hidden="true" class="header-anchor">#</a> 2. 多个filter形成链</h3> <h3 id="_3-filter分两种类型"><a href="#_3-filter分两种类型" aria-hidden="true" class="header-anchor">#</a> 3. filter分两种类型</h3> <ul><li>GatewayFilter：作用于某些特定请求响应，必须配置使用条件（对哪些请求使用该filter）</li> <li>GlobalFilter：全局filter，作用于所有请求响应，无需配置使用条件</li></ul> <h3 id="_4-一个filter可以在两个阶段做事情："><a href="#_4-一个filter可以在两个阶段做事情：" aria-hidden="true" class="header-anchor">#</a> 4.一个filter可以在两个阶段做事情：</h3> <ul><li>pre：处理更改请求，典型如增加http header</li> <li>post：处理更改响应</li></ul> <h3 id="_5-filter在链中的顺序，取决于ordered接口返回的值："><a href="#_5-filter在链中的顺序，取决于ordered接口返回的值：" aria-hidden="true" class="header-anchor">#</a> 5. filter在链中的顺序，取决于Ordered接口返回的值：</h3> <ul><li>值越小，越靠前</li> <li>没实现Ordered接口，则order为null，放到链的末尾，最后处理</li> <li>同order值的filter暂时尚不清楚先后顺序</li></ul> <h2 id="四、实战"><a href="#四、实战" aria-hidden="true" class="header-anchor">#</a> 四、实战</h2> <h3 id="_1-准备"><a href="#_1-准备" aria-hidden="true" class="header-anchor">#</a> 1. 准备</h3> <ul><li>确认已经启动
<ul><li>consul</li> <li>provider</li></ul></li> <li>确认gateway可运行</li></ul> <h3 id="_2-logfilter"><a href="#_2-logfilter" aria-hidden="true" class="header-anchor">#</a> 2. LogFilter</h3> <h4 id="（1）增加logfilter-java"><a href="#（1）增加logfilter-java" aria-hidden="true" class="header-anchor">#</a> （1）增加LogFilter.java</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gateway</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>support</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer</span><span class="token punctuation">.</span><span class="token class-name">NettyDataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer</span><span class="token punctuation">.</span><span class="token class-name">NettyDataBufferFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">MediaType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Mono</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>ipc<span class="token punctuation">.</span>netty</span><span class="token punctuation">.</span><span class="token class-name">ByteBufFlux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>ipc<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client</span><span class="token punctuation">.</span><span class="token class-name">HttpClientResponse</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;filter() req path: &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HttpHeaders</span> reqHeaders <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;req headers: \n&quot;</span> <span class="token operator">+</span> <span class="token function">mapToString</span><span class="token punctuation">(</span>reqHeaders<span class="token punctuation">.</span><span class="token function">toSingleValueMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;filter res&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HttpHeaders</span> resHeaders <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;res headers: \n&quot;</span> <span class="token operator">+</span> <span class="token function">mapToString</span><span class="token punctuation">(</span>resHeaders<span class="token punctuation">.</span><span class="token function">toSingleValueMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">mapToString</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="_2-运行gateway，浏览器访问：-http-localhost-9999-provider-test"><a href="#_2-运行gateway，浏览器访问：-http-localhost-9999-provider-test" aria-hidden="true" class="header-anchor">#</a> (2)运行gateway，浏览器访问： http://localhost:9999/provider/test</h4> <p>查看运行日志：</p> <div class="language- extra-class"><pre class="language-text"><code>2018-09-14 13:48:17.638 INFO 9845 --- [ctor-http-nio-2] c.e.g.LogFilter : filter() req path: /test
2018-09-14 13:48:17.639 INFO 9845 --- [ctor-http-nio-2] c.e.g.LogFilter : req headers: 
Host:localhost:9999
Accept:text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Upgrade-Insecure-Requests:1
Cookie:sidebar_collapsed=false; _gitlab_session=33b0662db87be0e013a7e2979a930caa; remember_user_token=W1syXSwiJDJhJDEwJE1keHJGNi4zejFXQURneVJ2dkZhb08iLCIxNTM2NzQ1MjQ2LjM4ODIyMTUiXQ%3D%3D--8b57439373473ccb73f8cb870493017a76676dc4; last-serviceName=consumer
User-Agent:Mozilla/5.0 (Macintosh; Intel Mac OS X 10_13_6) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/11.1.2 Safari/605.1.15
Accept-Language:en-us
Accept-Encoding:gzip, deflate
Connection:keep-alive

...

2018-09-14 13:48:17.989 INFO 9845 --- [ctor-http-nio-3] c.e.g.LogFilter : filter res
2018-09-14 13:48:17.989 INFO 9845 --- [ctor-http-nio-3] c.e.g.LogFilter : res headers: 
Content-Type:application/json;charset=UTF-8
Date:Fri, 14 Sep 2018 05:48:17 GMT
</code></pre></div><p>注：</p> <p>本节顺便演示了请求和响应两个阶段的filter处理</p> <h3 id="_3-默认filter链"><a href="#_3-默认filter链" aria-hidden="true" class="header-anchor">#</a> 3. 默认Filter链</h3> <h4 id="（1）在logfilter的filter接口打断点，以debug方式重新运行gateway"><a href="#（1）在logfilter的filter接口打断点，以debug方式重新运行gateway" aria-hidden="true" class="header-anchor">#</a> （1）在LogFilter的filter接口打断点，以debug方式重新运行gateway</h4> <h4 id="（2）浏览器访问：-http-localhost-9999-provider-test"><a href="#（2）浏览器访问：-http-localhost-9999-provider-test" aria-hidden="true" class="header-anchor">#</a> （2）浏览器访问： http://localhost:9999/provider/test</h4> <h4 id="（3）在idea中查看当前栈中chain变量："><a href="#（3）在idea中查看当前栈中chain变量：" aria-hidden="true" class="header-anchor">#</a> （3）在IDEA中查看当前栈中chain变量：</h4> <p><img src="/assets/img/stack.6f62339a.jpg" alt="图片" title="图片"></p> <p>可以发现，除LogFilter外总共有10个默认Filter，及他们的order值，按order顺序整理后，如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter&quot;: -2147482648
&quot;org.springframework.cloud.gateway.filter.NettyWriteResponseFilter&quot;: -1
&quot;org.springframework.cloud.gateway.filter.ForwardPathFilter&quot;: 0
&quot;org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory&quot;:1
&quot;org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter&quot;: 10000
&quot;org.springframework.cloud.gateway.filter.LoadBalancerClientFilter&quot;: 10100
&quot;org.springframework.cloud.gateway.filter.WebsocketRoutingFilter&quot;: 2147483646
&quot;org.springframework.cloud.gateway.filter.NettyRoutingFilter&quot;: 2147483647
&quot;org.springframework.cloud.gateway.filter.ForwardRoutingFilter&quot;: 2147483647
&quot;com.example.gateway.LogFilter&quot;: 
</code></pre></div><p>这里就是各Filter执行顺序，如果深入这些Filter源码，可以发现：</p> <ul><li>NettyWriteResponseFilter中不对request处理，而是对response的处理</li> <li>RewritePathGatewayFilterFactory中把/provider/test这样的path改成了/test这样的path（原来的path保存起来了）</li> <li>LoadBalancerClientFilter通过ribbon获取consul中的服务列表进行负载均衡处理</li> <li>LogFilter由于目前没有实现Ordered接口，被放在最后处理</li></ul> <h3 id="_4-实现logfiler的ordered接口："><a href="#_4-实现logfiler的ordered接口：" aria-hidden="true" class="header-anchor">#</a> 4. 实现LogFiler的Ordered接口：</h3> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gateway</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>support</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core</span><span class="token punctuation">.</span><span class="token class-name">Ordered</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer</span><span class="token punctuation">.</span><span class="token class-name">NettyDataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer</span><span class="token punctuation">.</span><span class="token class-name">NettyDataBufferFactory</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">MediaType</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Mono</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>ipc<span class="token punctuation">.</span>netty</span><span class="token punctuation">.</span><span class="token class-name">ByteBufFlux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>ipc<span class="token punctuation">.</span>netty<span class="token punctuation">.</span>http<span class="token punctuation">.</span>client</span><span class="token punctuation">.</span><span class="token class-name">HttpClientResponse</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LogFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ServerHttpRequest</span> request <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;filter() req path: &quot;</span> <span class="token operator">+</span> request<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">HttpHeaders</span> reqHeaders <span class="token operator">=</span> request<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;req headers: \n&quot;</span> <span class="token operator">+</span> <span class="token function">mapToString</span><span class="token punctuation">(</span>reqHeaders<span class="token punctuation">.</span><span class="token function">toSingleValueMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">defer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;filter res&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ServerHttpResponse</span> response <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">HttpHeaders</span> resHeaders <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;res headers: \n&quot;</span> <span class="token operator">+</span> <span class="token function">mapToString</span><span class="token punctuation">(</span>resHeaders<span class="token punctuation">.</span><span class="token function">toSingleValueMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Mono</span><span class="token punctuation">.</span><span class="token function">empty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">mapToString</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">StringBuffer</span> sb <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StringBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> key <span class="token operator">:</span> map<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> value <span class="token operator">=</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span>key<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> value<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            sb<span class="token punctuation">.</span><span class="token function">append</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> sb<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">9000</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这时，所有filter接口顺序如下：</p> <div class="language- extra-class"><pre class="language-text"><code>&quot;org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter&quot;: -2147482648
&quot;org.springframework.cloud.gateway.filter.NettyWriteResponseFilter&quot;: -1
&quot;org.springframework.cloud.gateway.filter.ForwardPathFilter&quot;: 0
&quot;org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory”:1
&quot;com.example.gateway.LogFilter&quot;: 9000
&quot;org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter&quot;: 10000
&quot;org.springframework.cloud.gateway.filter.LoadBalancerClientFilter&quot;: 10100
&quot;org.springframework.cloud.gateway.filter.WebsocketRoutingFilter&quot;: 2147483646
&quot;org.springframework.cloud.gateway.filter.NettyRoutingFilter&quot;: 2147483647
&quot;org.springframework.cloud.gateway.filter.ForwardRoutingFilter&quot;: 2147483647
</code></pre></div><p>注：</p> <ul><li>自定义的filter的order值建议在1-10000之间</li> <li>LogFilter可以设计在比较靠近10000的位置</li></ul> <h3 id="_5-屏蔽内部微服务接口：blockfilter"><a href="#_5-屏蔽内部微服务接口：blockfilter" aria-hidden="true" class="header-anchor">#</a> 5. 屏蔽内部微服务接口：BlockFilter</h3> <h4 id="（1）增加blockfilter-java"><a href="#（1）增加blockfilter-java" aria-hidden="true" class="header-anchor">#</a> （1）增加BlockFilter.java</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gateway</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>support</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core</span><span class="token punctuation">.</span><span class="token class-name">Ordered</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer</span><span class="token punctuation">.</span><span class="token class-name">DataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpRequest</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span>URI<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Iterator</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">LinkedHashSet</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">BlockFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;filter() req path: &quot;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;/provider/block&quot;</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerHttpResponse</span> serverHttpResponse <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverHttpResponse<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>UNAUTHORIZED<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token string">&quot;UNAUTHORIZED&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> defaultPath <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> uris <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LinkedHashSet</span><span class="token punctuation">)</span>exchange<span class="token punctuation">.</span><span class="token function">getRequiredAttribute</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">.</span>GATEWAY_ORIGINAL_REQUEST_URL_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>uris <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> uris<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> defaultPath<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> uris<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URI</span> originURI <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> originURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">100</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="（2）重新运行后，浏览器访问：-http-localhost-9999-proivder-test-查看日志："><a href="#（2）重新运行后，浏览器访问：-http-localhost-9999-proivder-test-查看日志：" aria-hidden="true" class="header-anchor">#</a> （2）重新运行后，浏览器访问： http://localhost:9999/proivder/test, 查看日志：</h4> <div class="language- extra-class"><pre class="language-text"><code>filter() req path: /provider/test
</code></pre></div><p>这里的实现把原始请求path： /provider/test取到了，对比LogFilter的日志，只是输出path： /test</p> <h4 id="（3）浏览器访问：-http-localhost-9999-proivder-block，返回："><a href="#（3）浏览器访问：-http-localhost-9999-proivder-block，返回：" aria-hidden="true" class="header-anchor">#</a> （3）浏览器访问： http://localhost:9999/proivder/block，返回：</h4> <div class="language- extra-class"><pre class="language-text"><code>UNAUTHORIZED
</code></pre></div><h3 id="_6-认证"><a href="#_6-认证" aria-hidden="true" class="header-anchor">#</a> 6. 认证</h3> <h4 id="（1）增加authfilter-java"><a href="#（1）增加authfilter-java" aria-hidden="true" class="header-anchor">#</a> （1）增加AuthFilter.java</h4> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>example<span class="token punctuation">.</span>gateway</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j</span><span class="token punctuation">.</span><span class="token class-name">Slf4j</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GatewayFilterChain</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>filter</span><span class="token punctuation">.</span><span class="token class-name">GlobalFilter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>cloud<span class="token punctuation">.</span>gateway<span class="token punctuation">.</span>support</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core</span><span class="token punctuation">.</span><span class="token class-name">Ordered</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>core<span class="token punctuation">.</span>io<span class="token punctuation">.</span>buffer</span><span class="token punctuation">.</span><span class="token class-name">DataBuffer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http</span><span class="token punctuation">.</span><span class="token class-name">HttpStatus</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>reactive</span><span class="token punctuation">.</span><span class="token class-name">ServerHttpResponse</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>stereotype</span><span class="token punctuation">.</span><span class="token class-name">Component</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>web<span class="token punctuation">.</span>server</span><span class="token punctuation">.</span><span class="token class-name">ServerWebExchange</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Flux</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">reactor<span class="token punctuation">.</span>core<span class="token punctuation">.</span>publisher</span><span class="token punctuation">.</span><span class="token class-name">Mono</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>net</span><span class="token punctuation">.</span>URI<span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util</span><span class="token punctuation">.</span>*<span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token keyword">static</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>logging<span class="token punctuation">.</span>log4j</span><span class="token punctuation">.</span><span class="token class-name">ThreadContext</span><span class="token punctuation">.</span>containsKey<span class="token punctuation">;</span>

<span class="token annotation punctuation">@Component</span>
<span class="token annotation punctuation">@Slf4j</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthFilter</span> <span class="token keyword">implements</span> <span class="token class-name">GlobalFilter</span><span class="token punctuation">,</span> <span class="token class-name">Ordered</span><span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> WHITE_LIST_URLS <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">&quot;/provider/login&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Mono</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">,</span> <span class="token class-name">GatewayFilterChain</span> chain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> path <span class="token operator">=</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;filter() req path: &quot;</span> <span class="token operator">+</span> path<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>WHITE_LIST_URLS<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>path<span class="token operator">:</span><span class="token operator">:</span><span class="token function">startsWith</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findAny</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">HttpHeaders</span> headers <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getHeaders</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>headers<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span><span class="token string">&quot;X-TOKEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">ServerHttpResponse</span> serverHttpResponse <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            serverHttpResponse<span class="token punctuation">.</span><span class="token function">setStatusCode</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span>BAD_REQUEST<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token string">&quot;Bad Request&quot;</span><span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">DataBuffer</span> buffer <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">bufferFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> exchange<span class="token punctuation">.</span><span class="token function">getResponse</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">writeWith</span><span class="token punctuation">(</span><span class="token class-name">Flux</span><span class="token punctuation">.</span><span class="token function">just</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">String</span> token <span class="token operator">=</span> headers<span class="token punctuation">.</span><span class="token function">getFirst</span><span class="token punctuation">(</span><span class="token string">&quot;X-TOKEN&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//        @Todo</span>
<span class="token comment">//        String userInfo = authService.auth(token);</span>
<span class="token comment">//        if (userInfo == null){</span>
<span class="token comment">//            ServerHttpResponse serverHttpResponse = exchange.getResponse();</span>
<span class="token comment">//            serverHttpResponse.setStatusCode(HttpStatus.BAD_REQUEST);</span>
<span class="token comment">//            byte[] bytes = &quot;Invalid Token&quot;.getBytes();</span>
<span class="token comment">//            DataBuffer buffer = exchange.getResponse().bufferFactory().wrap(bytes);</span>
<span class="token comment">//            return exchange.getResponse().writeWith(Flux.just(buffer));</span>
<span class="token comment">//        }</span>

        <span class="token keyword">return</span> chain<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>exchange<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getOriginalPath</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchange</span> exchange<span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">String</span> defaultPath <span class="token operator">=</span> exchange<span class="token punctuation">.</span><span class="token function">getRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">LinkedHashSet</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> uris <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">LinkedHashSet</span><span class="token punctuation">)</span>exchange<span class="token punctuation">.</span><span class="token function">getRequiredAttribute</span><span class="token punctuation">(</span><span class="token class-name">ServerWebExchangeUtils</span><span class="token punctuation">.</span>GATEWAY_ORIGINAL_REQUEST_URL_ATTR<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>uris <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">||</span> uris<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">return</span> defaultPath<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span>URI<span class="token punctuation">&gt;</span></span> iterator <span class="token operator">=</span> uris<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">URI</span> originURI <span class="token operator">=</span> iterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> originURI<span class="token punctuation">.</span><span class="token function">getPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getOrder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token number">200</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="（2）测试拦截"><a href="#（2）测试拦截" aria-hidden="true" class="header-anchor">#</a> （2）测试拦截</h4> <p>重启gateway后，浏览器访问：http://localhost:9999/provider/test,返回：</p> <div class="language- extra-class"><pre class="language-text"><code>Bad Request
</code></pre></div><p>是由于不是白名单url，而且没有传递http header： X-TOKEN，导致被拦截了</p> <h4 id="（3）测试白名单"><a href="#（3）测试白名单" aria-hidden="true" class="header-anchor">#</a> （3）测试白名单</h4> <p>浏览器访问: http://localhost:9999/provider/login,返回：</p> <div class="language- extra-class"><pre class="language-text"><code>Whitelabel Error Page

This application has no explicit mapping for /error, so you are seeing this as a fallback.

Fri Sep 14 15:11:53 CST 2018
There was an unexpected error (type=Not Found, status=404).
No message available
</code></pre></div><p>这是白名单中url，不会被filter拦截，但provider没有提供login接口，导致了这个错误。有兴趣的同学自己实现provider的login接口，就正常了。</p> <h4 id="（4-测试带x-token请求"><a href="#（4-测试带x-token请求" aria-hidden="true" class="header-anchor">#</a> （4) 测试带X-TOKEN请求</h4> <p>命令行通过curl访问：http://localhost:9999/provider/test （你也可以选择postman等http工具来实现发送带自定义header的请求）</p> <div class="language- extra-class"><pre class="language-text"><code>curl -H &quot;X-TOKEN: xxxx&quot; http://localhost:9999/provider/test&quot;
</code></pre></div><p>正常返回接口内容</p> <h4 id="（5）todo"><a href="#（5）todo" aria-hidden="true" class="header-anchor">#</a> （5）todo</h4> <p>有兴趣的同学可以把AuthFilter中注释的代码跑通，实现token到用户信息的转换，并添加到request头部中，传递给网关后的微服务</p> <h3 id="_7-到目前为止所有filter及顺序"><a href="#_7-到目前为止所有filter及顺序" aria-hidden="true" class="header-anchor">#</a> 7. 到目前为止所有Filter及顺序</h3> <div class="language- extra-class"><pre class="language-text"><code>&quot;org.springframework.cloud.gateway.filter.AdaptCachedBodyGlobalFilter&quot;: -2147482648
&quot;org.springframework.cloud.gateway.filter.NettyWriteResponseFilter&quot;: -1
&quot;org.springframework.cloud.gateway.filter.ForwardPathFilter&quot;: 0
&quot;org.springframework.cloud.gateway.filter.factory.RewritePathGatewayFilterFactory”:1
“com.example.gateway.BlockFilter&quot;: 100
&quot;com.example.gateway.AuthFilter&quot;: 200
&quot;com.example.gateway.LogFilter&quot;: 9000
&quot;org.springframework.cloud.gateway.filter.RouteToRequestUrlFilter&quot;: 10000
&quot;org.springframework.cloud.gateway.filter.LoadBalancerClientFilter&quot;: 10100
&quot;org.springframework.cloud.gateway.filter.WebsocketRoutingFilter&quot;: 2147483646
&quot;org.springframework.cloud.gateway.filter.NettyRoutingFilter&quot;: 2147483647
&quot;org.springframework.cloud.gateway.filter.ForwardRoutingFilter&quot;: 2147483647
</code></pre></div></div> <footer><!----> <hr> <!----></footer></article> <div class="sticker vuepress-toc"><div class="vuepress-toc-item vuepress-toc-h2 active"><a href="#一、准备工作" title="一、准备工作">一、准备工作</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-docker-容器" title="1. docker &amp; 容器">1. docker &amp; 容器</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-consul注册发现服务中心" title="2. consul注册发现服务中心">2. consul注册发现服务中心</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-provider微服务实战" title="3. Provider微服务实战">3. Provider微服务实战</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-consumer微服务实战" title="4. Consumer微服务实战">4. Consumer微服务实战</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_5-网关spring-cloud-gateway实战" title="5. 网关spring-cloud-gateway实战">5. 网关spring-cloud-gateway实战</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#二、应用场景" title="二、应用场景">二、应用场景</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-统一认证" title="1. 统一认证">1. 统一认证</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-屏蔽内部微服务接口" title="2. 屏蔽内部微服务接口">2. 屏蔽内部微服务接口</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-灰度" title="3. 灰度">3. 灰度</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-进出口日志" title="4. 进出口日志">4. 进出口日志</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#三、原理" title="三、原理">三、原理</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-总原理图" title="1. 总原理图">1. 总原理图</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-多个filter形成链" title="2. 多个filter形成链">2. 多个filter形成链</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-filter分两种类型" title="3. filter分两种类型">3. filter分两种类型</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-一个filter可以在两个阶段做事情：" title="4.一个filter可以在两个阶段做事情：">4.一个filter可以在两个阶段做事情：</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_5-filter在链中的顺序，取决于ordered接口返回的值：" title="5. filter在链中的顺序，取决于Ordered接口返回的值：">5. filter在链中的顺序，取决于Ordered接口返回的值：</a></div><div class="vuepress-toc-item vuepress-toc-h2"><a href="#四、实战" title="四、实战">四、实战</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_1-准备" title="1. 准备">1. 准备</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_2-logfilter" title="2. LogFilter">2. LogFilter</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_3-默认filter链" title="3. 默认Filter链">3. 默认Filter链</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_4-实现logfiler的ordered接口：" title="4. 实现LogFiler的Ordered接口：">4. 实现LogFiler的Ordered接口：</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_5-屏蔽内部微服务接口：blockfilter" title="5. 屏蔽内部微服务接口：BlockFilter">5. 屏蔽内部微服务接口：BlockFilter</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_6-认证" title="6. 认证">6. 认证</a></div><div class="vuepress-toc-item vuepress-toc-h3"><a href="#_7-到目前为止所有filter及顺序" title="7. 到目前为止所有Filter及顺序">7. 到目前为止所有Filter及顺序</a></div></div></div></div> <footer class="footer" data-v-fdbf4940><div class="footer-left-wrap" data-v-fdbf4940><ul class="contact" data-v-fdbf4940><li class="contact-item" data-v-fdbf4940><a href="https://github.com/shineyjg" target="_blank" rel="noopener noreferrer" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github" data-v-fdbf4940><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22" data-v-fdbf4940></path></svg>
          
        </a></li><li class="contact-item" data-v-fdbf4940><a href="mailto:shineyjg@gmail.com" class="nav-link external" data-v-fdbf4940><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-mail" data-v-fdbf4940><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" data-v-fdbf4940></path><polyline points="22,6 12,13 2,6" data-v-fdbf4940></polyline></svg>
          
        </a></li></ul></div> <div class="footer-right-wrap" data-v-fdbf4940><ul class="copyright" data-v-fdbf4940><li class="copyright-item" data-v-fdbf4940><a href="/" class="nav-link" data-v-fdbf4940>Vincent © 2020</a></li></ul></div></footer></div><div class="global-ui"><SWUpdatePopup></SWUpdatePopup></div></div>
    <script src="/assets/js/app.2f09ff3d.js" defer></script><script src="/assets/js/5.74ec0765.js" defer></script><script src="/assets/js/25.18f85102.js" defer></script>
  </body>
</html>
